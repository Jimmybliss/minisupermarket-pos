<form [formGroup]="saleForm" class="pos-container">
  <!-- Customer Section -->
  <div class="customer-section">
    <mat-form-field appearance="fill">
      <mat-label>Customer Name</mat-label>
      <input matInput formControlName="customer_name">
      <mat-error *ngIf="saleForm.get('customer_name')?.hasError('required')">
        Customer name is required
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Payment Method</mat-label>
      <mat-select formControlName="payment_method">
        <mat-option *ngFor="let method of paymentMethods" [value]="method">
          {{ method }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Right-side numpad -->
  <aside class="numpad-sidebar" aria-hidden="false">
    <div class="numpad-display">{{ getActiveValue() }}</div>
    <div class="numpad-grid">
      <button mat-raised-button (click)="appendNumpad('7')">7</button>
      <button mat-raised-button (click)="appendNumpad('8')">8</button>
      <button mat-raised-button (click)="appendNumpad('9')">9</button>
      <button mat-raised-button (click)="appendNumpad('4')">4</button>
      <button mat-raised-button (click)="appendNumpad('5')">5</button>
      <button mat-raised-button (click)="appendNumpad('6')">6</button>
      <button mat-raised-button (click)="appendNumpad('1')">1</button>
      <button mat-raised-button (click)="appendNumpad('2')">2</button>
      <button mat-raised-button (click)="appendNumpad('3')">3</button>
      <button mat-raised-button (click)="appendNumpad('0')">0</button>
      <button mat-raised-button (click)="appendNumpad('.')">.</button>
      <button mat-raised-button color="warn" (click)="backspaceActive()">âŒ«</button>
      <button mat-stroked-button color="primary" (click)="clearActive()">Clear</button>
    </div>
  </aside>

  <!-- Items Section -->
  <div formArrayName="items" class="items-section">
    <div *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="item-row">
      <div class="row">
        <!-- Search Product with Autocomplete -->
        <mat-form-field appearance="fill" class="product-field">
          <mat-label>Search Product</mat-label>
          <input type="text" matInput [formControlName]="'product_search'" [matAutocomplete]='auto' [value]="selectedProducts[i]?.name || ''"
                 (keyup)="onProductSearch($event, i)">


          <mat-autocomplete #auto="matAutocomplete">
            <mat-option *ngFor="let product of filteredProducts[i]" (click)="onProductSelect(product, i)">
              {{ product.name }} - {{ product.price | currency:'TZS':'symbol':'1.0-2' }}
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <!-- Quantity -->
        <mat-form-field appearance="fill" class="small-field">
          <mat-label>Quantity</mat-label>
          <input matInput type="number" formControlName="quantity" (change)="updateSubtotal(i)" min="1">
        </mat-form-field>

        <!-- Price -->
        <mat-form-field appearance="fill" class="small-field">
          <mat-label>Price</mat-label>
          <input matInput type="number" formControlName="price" readonly>
        </mat-form-field>

        <!-- Remove Item -->
        <button mat-icon-button color="warn" (click)="removeItem(i)" *ngIf="items.length > 1">
          <mat-icon>delete</mat-icon>
        </button>

      </div>      
    </div>
  </div>

  <!-- Totals Section -->
  <div class="totals-section">
    <mat-card>
      <mat-card-content class="card-content">
        <div class="total-rows">
          <div class="total-row">
          <span>Subtotal:</span>
          <span>{{ subtotal | currency:'TZS':'symbol':'1.0-2' }}</span>
          </div>
        
        <div class="total-row">
          <span>Tax :</span>
          <span>{{ tax | currency:'TZS':'symbol':'1.0-2' }}</span>
        </div>

        <div class="total-row">
          <span>Discount:</span>
          <mat-form-field appearance="fill">
            <input matInput 
                   type="number" 
                   formControlName="discount"
                   min="0"
                   max="100">
            <span matSuffix>%</span>
          </mat-form-field>
          <span>-{{ discountAmount | currency:'TZS':'symbol':'1.0-2' }}</span>
        </div>

        <div class="total-row grand-total">
          <span>Total:</span>
          <span>{{ grandTotal | currency:'TZS':'symbol':'1.0-2' }}</span>
        </div>
        
        <button mat-raised-button 
      color="accent" 
      (click)="submitSale()"
      [disabled]="!canSubmit()"
      class="submit-btn">
      <mat-icon>check_circle</mat-icon>
      {{ isLoading ? 'Processing...' : 'Complete Sale' }}
    </button>


      </div>
      
      </mat-card-content>
    </mat-card>

  
  </div>
</form>
